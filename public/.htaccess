# === Rewrite & Routing ===
<IfModule mod_rewrite.c>
    RewriteEngine On
    Options -MultiViews

    # Se è un file o una cartella reale, servilo direttamente
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # /admin e sottopercorsi -> admin.php
    RewriteRule ^admin(?:/.*)?$ admin.php [QSA,L]

    # Tutto il resto -> index.php
    RewriteRule ^ index.php [QSA,L]
</IfModule>

# === Sicurezza base ===
# Niente listing
Options -Indexes

# Blocca dotfiles e file sensibili (incluso .env.php)
<FilesMatch "(^\.|\.env(\.php)?|composer\.(json|lock)|package(-lock)?\.json|pnpm-lock\.yaml|yarn\.lock|webpack.*|vite.*|Makefile|README.*|LICENSE|.*\.(sql|sqlite|bak|zip|tar|gz|tgz))$">
    Require all denied
</FilesMatch>

# Blocca mappe sorgenti e markdown
<FilesMatch "\.(map|md)$">
    Require all denied
</FilesMatch>

# Impedisci esecuzione PHP dove non serve (assets/upload)
<IfModule mod_php.c>
    <FilesMatch "^assets/.*\.(php|phar|phtml)$">
        Require all denied
    </FilesMatch>
    <FilesMatch "^uploads/.*\.(php|phar|phtml)$">
        Require all denied
    </FilesMatch>
</IfModule>

# Consenti solo metodi standard
<LimitExcept GET POST HEAD>
    Require all denied
</LimitExcept>

# === Security headers ===
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    # HSTS: abilitalo solo se TUTTO è in HTTPS
    Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains; preload" env=HTTPS
    # Riduci superfici API del browser
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), bluetooth=()"
    # Protezione download
    Header always set X-Download-Options "noopen"
</IfModule>

# Caching statico leggero
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 7 days"
    ExpiresByType application/javascript "access plus 7 days"
    ExpiresByType image/svg+xml "access plus 30 days"
    ExpiresByType image/png "access plus 30 days"
    ExpiresByType image/jpeg "access plus 30 days"
    ExpiresByType image/webp "access plus 30 days"
</IfModule>
